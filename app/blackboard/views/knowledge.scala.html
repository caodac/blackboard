@import play.twirl.api.HtmlFormat
@import java.net.URLEncoder
@import _root_.blackboard.utils.Util
@import _root_.blackboard.pubmed.index.PubMedIndex._
@import _root_.blackboard.controllers.routes
@import _root_.blackboard.controllers.KnowledgeApp
@(app: KnowledgeApp, page: Integer, pages: Array[Int],
       urls: Map[Integer, String], result: SearchResult, refs: SearchResult)

@paging() = {
  @if(pages.length > 0) {
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      @for(i <- pages) {
        @if(i == 0) {
          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1" onclick="showloader()">
              <span><i class="fa fa-ellipsis-h"></i></span>
            </a>
          </li>
        }else{
          @if(i == page) {
            <li class="page-item active">
              <a class="page-link" tabindex="-1"
                 href="#" onclick="showloader()">@i
                <span class="sr-only">(current)</span></a></li>
          }else{
            <li class="page-item">
              <a class="page-link" onclick="showloader()"
                 href="@urls(i)">@i</a></li>
          }
        }
      }
    </ul>
  </nav>
  }
}

@jstree(name: String, prefix: String) = {
    @defining(result.getFacet("@tr"+prefix)){ tr =>
      @if(tr != null) {
        @_root_.blackboard.pubmed.views.html.facettreecard(name, tr.getValuesWithPrefix(prefix), prefix)
      }
    }
}

@facettrees() = {
    @**facetcard(app, "MesH", result.getFacet("@ui"))**@
    @jstree("Disease", "C")
    @jstree("Chemical", "D")
    @jstree("Phenomena", "G")
    @jstree("Anatomy", "A")
    @jstree("Analytical", "E")
}

@views.html.ui.main("NCATS Knowledge Base"){
  <script>
  var filters = {}
  </script>
  
  <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="https://ncats.nih.gov">
      <img src='@controllers.routes.Assets.versioned("images/ncats-logo.png")'
           height="65%" width="65%">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarTogglerMenu"
            aria-controls="navbarTogglerMenu"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarTogglerMenu">
      <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="@routes.KnowledgeApp.index">Home</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="#">publications (@result.total)</a>
        </li>
        @if(result.query.getQuery != null) {
          <li class="nav-item">
            <a class="nav-link" href='@_root_.blackboard.disease.controllers.routes.Controller.diseases(request.getQueryString("q"))'>diseases (<span id="disease-count">...</span>)</a>
          </li>
        }
      </ul>
      <form id="search-form" class="form-inline my-2 my-lg-0"
            method="GET" action="@routes.KnowledgeApp.ksearch(null)">
        <input class="form-control mr-sm-2" type="search" name="q"
               placeholder="ENTER SEARCH TERMS..." style="width:20em">
        <button class="btn btn-primary my-2 my-sm-0"
                type="submit" style="border-radius:3rem">Search</button>
      </form>
    </div>
  </nav>  
  <div class="container-fluid" style="margin-top: 55px; margin-bottom:10px;">
    <div id="content-panel" class="loader loader-default"></div>     
    <div class="row">
      @defining(result.getFacet("@tr")){ tr =>
        @if(tr != null){
          <div class="d-flex" id="wrapper">
             <div class="border-left" id="sidebar-wrapper">
             @facettrees()
             </div>
        }
        
        <div class="col-md-3">
          @** FILTERS **@
          @facetcard(app, "Year_Published", result.getFacet("@year"))
          @facetcard(app, "Author", result.getFacet("@author"))
          @facetcard(app, "Article_Type", result.getFacet("@pubtype"))
          @facetcard(app, "Journal", result.getFacet("@journal"))
          @facetcard(app, "Keyword", result.getFacet("@keyword"))
          @facetcard(app, "Concept", result.getFacet("@cui"))
          @facetcard(app, "Semantic_Type", result.getFacet("@semtype"))
          @if(tr != null){
            <br><button class="btn btn-primary pull-right"
                        id="menu-toggle">More...</button>
          }
        </div>
        <div class="col-md-6">
          @** SEARCH CONTENTS **@
          @for(d <- result.docs) {
            @articlecard(d,"?"+Util.getQueryString(request, "q", "facet"))
            }
            <div class="alert fade show" role="alert">
              @paging()
            </div>
        </div>
        <div class="col-md-3">
          @** CONTEXT **@
          @contextcard(result.query){
            @result.total document@if(result.total!=1){s} matched
            }
            @if(refs != null && refs.size > 0){
              @refcard(refs)
              }
        </div>
       @if(tr != null){
       </div>
       }
    }
    </div>
  </div>
  }{
  <script src="@_root_.blackboard.disease.controllers.routes.Controller.jsRoutes" type="text/javascript"></script>
  <script src='@controllers.routes.Assets.versioned("javascripts/treefacets.js")' type="text/javascript"></script>
  }{
      $(document).ready(function() {
          console.log('@HtmlFormat.raw(request.uri)');
          $('#wrapper').toggleClass('toggled');
          $("#menu-toggle").click(function(e) {
              e.preventDefault();
              $("#wrapper").toggleClass("toggled");
              if ($('#wrapper').hasClass('toggled')) {
                  $('#menu-toggle').html("More...");
              }
              else {
                  $('#menu-toggle').html("Less...");
              }
          });

          $('#search-form').on('submit', function(e) {
              showloader();
          });
          setupTreeFacets ();
          
          /*
            $('.facet-item').each(function () {
            console.log($(this).attr('id')+' '+$(this).attr('value')+' '+$(this).is(':checked'));
            });
          */
          for(var id in filters) {
              var f = filters[id];
              if (f.checked) {
                  console.log(id+'='+f.name+'/'+f.value+' ');
              }
          }
          
          @if(result.query.getQuery != null) {
              var urlParams = new URLSearchParams(window.location.search);
              var query = urlParams.get('q');
              var route = diseaseRoutes.blackboard.disease
                  .controllers.Controller.search(query);
              var url = route.url;
              url += (url.indexOf('?') > 0 ? '&':'?')+'path=/total';
              $.ajax({
                  url: url,
                  success: function(data) {
                      console.log('***** '+url+' '+data);
                      $('#disease-count').html(''+data);
                  },
                  error: function(){
                      $('#disease-count').html('?');
                      console.log('failed to retrieve disease count!');
                  }
              });
          }
      });
      
      function filterToggle (el) {    
          console.log(location.href+' '+el.id+' '+el.value+' '+el.checked);
          filters[el.id].checked = el.checked;
          applyFilter ();
      }
      
      function applyFilter () {
          var params = new URLSearchParams (window.location.search);
          params.delete('skip');
          
          var facets = params.getAll('facet');
          params.delete('facet');
          for(var id in filters) {
              var f = filters[id];
              if (f.checked) {
                  params.append('facet', f.name+'/'+f.value);
              }
          }
          
          for (var i in facets) {
              if (facets[i].startsWith('@@tr')) {
                  params.append('facet', facets[i]);
              }
          }
  
          var url = '@request.path'+'?'+params.toString();
          console.log('=====> '+url);
          showloader ();
          
          $.ajax({
              'url': url,
              success: function () {
                  window.location.href = url;
              }
          }).done(function () {
              
          });
      }
  }
